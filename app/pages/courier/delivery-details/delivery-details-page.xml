<Page xmlns="http://schemas.nativescript.org/tns.xsd"
      navigatingTo="onNavigatingTo"
      class="page bg-gray-100">

    <ActionBar title="Delivery Details" class="action-bar">
        <NavigationButton text="Back" android.systemIcon="ic_menu_back" />
    </ActionBar>

    <GridLayout rows="*, auto">
        <ScrollView row="0">
            <StackLayout class="p-4">
                <!-- Loading State -->
                <ActivityIndicator busy="{{ isLoading }}"
                                   visibility="{{ isLoading ? 'visible' : 'collapsed' }}"
                                   class="text-blue-500" />

                <!-- Delivery Status Header -->
                <GridLayout columns="*, auto" class="bg-white p-4 rounded-lg mb-4" visibility="{{ !isLoading ? 'visible' : 'collapsed' }}">
                    <StackLayout col="0">
                        <Label text="{{ statusLabel }}" class="text-2xl font-bold {{ statusColor }}" />
                        <Label text="{{ delivery.id }}" class="text-xs text-gray-400 mt-1" />
                    </StackLayout>
                    <StackLayout col="1" class="items-end">
                        <Label text="{{ deliveryFeeFormatted }}" class="text-xl font-bold text-green-600" />
                        <Label text="Earnings" class="text-xs text-gray-500" />
                    </StackLayout>
                </GridLayout>

                <!-- Pickup Location -->
                <StackLayout class="bg-white p-4 rounded-lg mb-4" visibility="{{ !isLoading ? 'visible' : 'collapsed' }}">
                    <GridLayout columns="auto, *" class="mb-3">
                        <Label col="0" text="P" class="bg-green-500 text-white text-center w-8 h-8 rounded-full font-bold text-lg" />
                        <Label col="1" text="PICKUP" class="font-bold text-green-600 ml-3 text-lg" />
                    </GridLayout>
                    <Label text="{{ delivery.fromPharmacyName }}" class="font-bold text-lg" />
                    <Label text="{{ delivery.fromAddress }}" class="text-gray-600 mt-1" textWrap="true" />
                    <GridLayout columns="auto, *" class="mt-2">
                        <Label col="0" text="Phone:" class="text-gray-500" />
                        <Label col="1" text="{{ delivery.fromPhone }}" class="text-blue-600 ml-2" tap="{{ onCallPickup }}" />
                    </GridLayout>
                    <Label text="{{ pickupTimeFormatted }}" class="text-sm text-gray-500 mt-2"
                           visibility="{{ pickupTimeFormatted ? 'visible' : 'collapsed' }}" />
                </StackLayout>

                <!-- Delivery Location -->
                <StackLayout class="bg-white p-4 rounded-lg mb-4" visibility="{{ !isLoading ? 'visible' : 'collapsed' }}">
                    <GridLayout columns="auto, *" class="mb-3">
                        <Label col="0" text="D" class="bg-blue-500 text-white text-center w-8 h-8 rounded-full font-bold text-lg" />
                        <Label col="1" text="DELIVERY" class="font-bold text-blue-600 ml-3 text-lg" />
                    </GridLayout>
                    <Label text="{{ delivery.toPharmacyName }}" class="font-bold text-lg" />
                    <Label text="{{ delivery.toAddress }}" class="text-gray-600 mt-1" textWrap="true" />
                    <GridLayout columns="auto, *" class="mt-2">
                        <Label col="0" text="Phone:" class="text-gray-500" />
                        <Label col="1" text="{{ delivery.toPhone }}" class="text-blue-600 ml-2" tap="{{ onCallDelivery }}" />
                    </GridLayout>
                    <Label text="{{ deliveryTimeFormatted }}" class="text-sm text-gray-500 mt-2"
                           visibility="{{ deliveryTimeFormatted ? 'visible' : 'collapsed' }}" />
                </StackLayout>

                <!-- Medicine Details -->
                <StackLayout class="bg-white p-4 rounded-lg mb-4" visibility="{{ !isLoading ? 'visible' : 'collapsed' }}">
                    <Label text="Medicine Items" class="font-bold text-lg mb-3" />
                    <Label text="{{ delivery.medicineCount }} item(s)" class="text-gray-600 mb-2" />

                    <Repeater items="{{ delivery.medicineDetails }}">
                        <Repeater.itemTemplate>
                            <GridLayout columns="*, auto" class="py-2 border-b border-gray-100">
                                <StackLayout col="0">
                                    <Label text="{{ name }}" class="font-medium" />
                                    <Label text="Batch: {{ batchNumber || 'N/A' }}" class="text-xs text-gray-500" />
                                </StackLayout>
                                <Label col="1" text="x{{ quantity }}" class="text-gray-600" />
                            </GridLayout>
                        </Repeater.itemTemplate>
                    </Repeater>
                </StackLayout>

                <!-- Special Instructions -->
                <StackLayout class="bg-yellow-50 p-4 rounded-lg mb-4"
                             visibility="{{ delivery.specialInstructions ? 'visible' : 'collapsed' }}">
                    <Label text="Special Instructions" class="font-bold text-yellow-700 mb-2" />
                    <Label text="{{ delivery.specialInstructions }}" class="text-yellow-800" textWrap="true" />
                </StackLayout>

                <!-- Status Timeline -->
                <StackLayout class="bg-white p-4 rounded-lg mb-4" visibility="{{ !isLoading ? 'visible' : 'collapsed' }}">
                    <Label text="Status History" class="font-bold text-lg mb-3" />

                    <Repeater items="{{ statusHistory }}">
                        <Repeater.itemTemplate>
                            <GridLayout columns="auto, *" class="mb-3">
                                <StackLayout col="0" class="items-center mr-3">
                                    <Label text="" class="w-3 h-3 rounded-full {{ isLast ? 'bg-blue-500' : 'bg-gray-300' }}" />
                                    <Label text="" class="w-px h-6 {{ isLast ? 'bg-transparent' : 'bg-gray-300' }}" visibility="{{ isLast ? 'collapsed' : 'visible' }}" />
                                </StackLayout>
                                <StackLayout col="1">
                                    <Label text="{{ statusLabel }}" class="font-medium" />
                                    <Label text="{{ timestampFormatted }}" class="text-xs text-gray-500" />
                                    <Label text="{{ note }}" class="text-sm text-gray-600" visibility="{{ note ? 'visible' : 'collapsed' }}" />
                                </StackLayout>
                            </GridLayout>
                        </Repeater.itemTemplate>
                    </Repeater>
                </StackLayout>

                <!-- Earnings Info -->
                <StackLayout class="bg-green-50 p-4 rounded-lg mb-4" visibility="{{ showEarnings ? 'visible' : 'collapsed' }}">
                    <Label text="Earnings for this Delivery" class="font-bold text-green-700 mb-3" />
                    <GridLayout columns="*, *" rows="auto, auto, auto" class="text-sm">
                        <Label row="0" col="0" text="Delivery Fee:" class="text-gray-600" />
                        <Label row="0" col="1" text="{{ deliveryFeeFormatted }}" class="text-right font-medium" />

                        <Label row="1" col="0" text="Platform Fee:" class="text-gray-600 mt-1" />
                        <Label row="1" col="1" text="-{{ platformFeeFormatted }}" class="text-right text-red-500 mt-1" />

                        <Label row="2" col="0" text="Your Earnings:" class="font-bold text-green-700 mt-2" />
                        <Label row="2" col="1" text="{{ netEarningsFormatted }}" class="text-right font-bold text-green-700 mt-2" />
                    </GridLayout>
                    <Label text="{{ earningStatus }}" class="text-xs text-gray-500 mt-2 text-center" />
                </StackLayout>
            </StackLayout>
        </ScrollView>

        <!-- Action Buttons -->
        <StackLayout row="1" class="p-4 bg-white" visibility="{{ !isLoading &amp;&amp; showActions ? 'visible' : 'collapsed' }}">
            <!-- Pending: Accept -->
            <Button text="Accept Delivery"
                    class="bg-green-500 text-white p-4 rounded-lg font-bold"
                    tap="{{ onAcceptDelivery }}"
                    visibility="{{ delivery.status === 'pending' ? 'visible' : 'collapsed' }}" />

            <!-- Assigned: Start Pickup -->
            <Button text="Start Pickup (Scan QR)"
                    class="bg-blue-500 text-white p-4 rounded-lg font-bold"
                    tap="{{ onStartPickup }}"
                    visibility="{{ delivery.status === 'assigned' ? 'visible' : 'collapsed' }}" />

            <!-- Picked Up: Confirm Delivery -->
            <GridLayout columns="*, *" class="gap-2" visibility="{{ delivery.status === 'picked_up' || delivery.status === 'in_transit' ? 'visible' : 'collapsed' }}">
                <Button col="0"
                        text="Mark In Transit"
                        class="bg-orange-500 text-white p-4 rounded-lg"
                        tap="{{ onMarkInTransit }}"
                        visibility="{{ delivery.status === 'picked_up' ? 'visible' : 'collapsed' }}" />
                <Button col="1"
                        text="Complete Delivery"
                        class="bg-green-500 text-white p-4 rounded-lg font-bold"
                        tap="{{ onCompleteDelivery }}" />
            </GridLayout>

            <!-- Report Problem -->
            <Button text="Report Problem"
                    class="bg-red-100 text-red-600 p-3 rounded-lg mt-2"
                    tap="{{ onReportProblem }}"
                    visibility="{{ delivery.status !== 'delivered' &amp;&amp; delivery.status !== 'failed' &amp;&amp; delivery.status !== 'cancelled' ? 'visible' : 'collapsed' }}" />
        </StackLayout>
    </GridLayout>
</Page>
