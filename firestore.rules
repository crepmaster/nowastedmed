rules_version = '2';

/**
 * Firestore Security Rules for NoWastedMed (MediExchange)
 *
 * These rules enforce access control for the medicine exchange platform.
 *
 * Collections:
 * - pharmacies: Pharmacist user profiles
 * - couriers: Courier user profiles
 * - admins: Admin user profiles
 * - exchanges: Medicine exchange requests
 * - exchange_proposals: Counter-proposals for exchanges
 * - pharmacy_inventory: Medicine inventory
 *
 * SECURITY HARDENING (Phase 1):
 * - Financial mutations locked to Cloud Functions only
 * - Field-level protection on deliveries and exchanges
 * - Audit logs server-only
 * - Exchange proposals validated against parent
 *
 * DEPLOYMENT:
 * firebase deploy --only firestore:rules
 *
 * TESTING:
 * Use Firebase Emulator Suite for local testing
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user is accessing their own document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is a pharmacist
    function isPharmacist() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/pharmacies/$(request.auth.uid));
    }

    // Check if user is a courier
    function isCourier() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/couriers/$(request.auth.uid));
    }

    // Check if user is an admin
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Validate required string field
    function validRequiredString(field) {
      return field is string && field.size() > 0;
    }

    // Validate pharmacy has at least GPS coordinates OR address (min 5 chars)
    function hasValidPharmacyLocation(data) {
      let hasCoordinates = data.location != null &&
                           data.location.coordinates != null &&
                           data.location.coordinates.latitude is number &&
                           data.location.coordinates.longitude is number;
      let hasAddress = (data.address is string && data.address.size() >= 5) ||
                       (data.location != null && data.location.address is string && data.location.address.size() >= 5);
      return hasCoordinates || hasAddress;
    }

    // Check if courier operates in a specific city
    // Uses couriers collection as source of truth
    function courierOperatesInCity(cityId) {
      let courierDoc = get(/databases/$(database)/documents/couriers/$(request.auth.uid));
      return courierDoc != null &&
             courierDoc.data.operatingCities != null &&
             cityId in courierDoc.data.operatingCities;
    }

    // ============================================
    // USER PROFILE COLLECTIONS
    // ============================================

    // Pharmacies collection
    match /pharmacies/{userId} {
      // Owner and admin can read full profile
      // Other pharmacists can read for exchange purposes (limited PII exposure for demo)
      // NOTE: For production, consider splitting into pharmacies_public/pharmacies_private
      allow read: if isOwner(userId) || isAdmin() || isPharmacist();

      // Only the user can update their own profile
      // Protected fields: role, createdAt cannot be changed
      allow update: if isOwner(userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']);

      // Users can create their own profile during registration
      // Pharmacy must have at least GPS coordinates OR address
      allow create: if (isOwner(userId) || isAdmin()) &&
                       hasValidPharmacyLocation(request.resource.data);

      // Only admins can delete profiles
      allow delete: if isAdmin();
    }

    // Couriers collection
    match /couriers/{userId} {
      // Owner, admin, and pharmacists (for delivery tracking) can read
      allow read: if isOwner(userId) || isAdmin() || isPharmacist();

      // Only the user can update their own profile
      // Protected fields: role, createdAt cannot be changed
      allow update: if isOwner(userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']);

      // Users can create their own profile during registration
      allow create: if isOwner(userId) || isAdmin();

      // Only admins can delete profiles
      allow delete: if isAdmin();
    }

    // Admins collection
    match /admins/{userId} {
      // Only admins can read admin profiles
      allow read: if isOwner(userId) || isAdmin();

      // Only the user can update their own profile
      allow update: if isOwner(userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']);

      // Only existing admins can create new admins
      allow create: if isAdmin();

      // Only admins can delete admin profiles
      allow delete: if isAdmin();
    }

    // ============================================
    // PHARMACY INVENTORY
    // ============================================

    match /pharmacy_inventory/{medicineId} {
      // Pharmacies can read their own inventory
      // Other pharmacies can read medicines available for exchange
      // Admins can read all
      allow read: if isAuthenticated() && (
                     resource.data.pharmacyId == request.auth.uid ||
                     resource.data.availableForExchange == true ||
                     isAdmin()
                   );

      // Pharmacy can only create medicines for their own inventory
      allow create: if isPharmacist() &&
                       request.resource.data.pharmacyId == request.auth.uid &&
                       validRequiredString(request.resource.data.name) &&
                       request.resource.data.quantity >= 0;

      // Pharmacy can only update their own medicines
      // Cannot change pharmacyId
      allow update: if isPharmacist() &&
                       resource.data.pharmacyId == request.auth.uid &&
                       request.resource.data.pharmacyId == request.auth.uid &&
                       request.resource.data.quantity >= 0;

      // Pharmacy can only delete their own medicines
      allow delete: if isPharmacist() &&
                       resource.data.pharmacyId == request.auth.uid;
    }

    // ============================================
    // EXCHANGES
    // ============================================

    match /exchanges/{exchangeId} {
      // Both proposer and recipient can read the exchange
      // Couriers can read exchanges they are delivering
      // Admins can read all
      allow read: if isAuthenticated() && (
                     resource.data.proposedBy == request.auth.uid ||
                     resource.data.proposedTo == request.auth.uid ||
                     resource.data.courierId == request.auth.uid ||
                     isAdmin()
                   );

      // Only pharmacists can create exchanges
      // Must be the proposer with valid initial status
      allow create: if isPharmacist() &&
                       request.resource.data.proposedBy == request.auth.uid &&
                       request.resource.data.status in ['draft', 'pending', 'requested'];

      // SECURITY HARDENING: Field-level protection on updates
      // Immutable fields that can NEVER change after creation
      allow update: if isAuthenticated() && (
                       // Proposer can update (but not critical fields)
                       (resource.data.proposedBy == request.auth.uid &&
                        request.resource.data.proposedBy == resource.data.proposedBy &&
                        // Cannot change proposedTo once set (except from empty)
                        (resource.data.proposedTo == '' ||
                         request.resource.data.proposedTo == resource.data.proposedTo ||
                         resource.data.proposedTo == null)) ||

                       // Recipient can accept/reject only - cannot modify other fields
                       (resource.data.proposedTo == request.auth.uid &&
                        request.resource.data.status in ['accepted', 'rejected', 'pending'] &&
                        request.resource.data.proposedBy == resource.data.proposedBy &&
                        request.resource.data.proposedTo == resource.data.proposedTo &&
                        request.resource.data.proposedMedicines == resource.data.proposedMedicines) ||

                       // Courier can ONLY update status - nothing else
                       (isCourier() &&
                        resource.data.courierId == request.auth.uid &&
                        request.resource.data.status in ['in_transit', 'completed'] &&
                        request.resource.data.proposedBy == resource.data.proposedBy &&
                        request.resource.data.proposedTo == resource.data.proposedTo &&
                        request.resource.data.proposedMedicines == resource.data.proposedMedicines &&
                        request.resource.data.offeredMedicines == resource.data.offeredMedicines) ||

                       // Admin can update any exchange
                       isAdmin()
                     );

      // Only proposer can delete draft exchanges
      allow delete: if (isPharmacist() &&
                        resource.data.proposedBy == request.auth.uid &&
                        resource.data.status == 'draft') ||
                       isAdmin();
    }

    // ============================================
    // EXCHANGE PROPOSALS
    // ============================================

    match /exchange_proposals/{proposalId} {
      // Helper to get parent exchange for validation
      function getParentExchange() {
        return get(/databases/$(database)/documents/exchanges/$(resource.data.exchangeId));
      }

      // Helper to get parent exchange for create validation (uses request data)
      function getParentExchangeForCreate() {
        return get(/databases/$(database)/documents/exchanges/$(request.resource.data.exchangeId));
      }

      // Both parties involved in the exchange can read proposals
      allow read: if isAuthenticated() && (
                     getParentExchange().data.proposedBy == request.auth.uid ||
                     getParentExchange().data.proposedTo == request.auth.uid ||
                     isAdmin()
                   );

      // SECURITY FIX: Validate proposal is linked to a valid exchange
      // Creator must be a party to the exchange
      allow create: if isPharmacist() &&
                       request.resource.data.proposedBy == request.auth.uid &&
                       request.resource.data.exchangeId != null &&
                       getParentExchangeForCreate() != null &&
                       (getParentExchangeForCreate().data.proposedBy == request.auth.uid ||
                        getParentExchangeForCreate().data.proposedTo == request.auth.uid);

      // Only parties can update proposal status
      // Cannot change exchangeId or proposedBy
      allow update: if isAuthenticated() && (
                       (getParentExchange().data.proposedBy == request.auth.uid ||
                        getParentExchange().data.proposedTo == request.auth.uid) &&
                       request.resource.data.exchangeId == resource.data.exchangeId &&
                       request.resource.data.proposedBy == resource.data.proposedBy
                     );

      // Only proposer can delete their proposal
      allow delete: if isPharmacist() &&
                       resource.data.proposedBy == request.auth.uid;
    }

    // ============================================
    // ADMIN LOCATION MANAGEMENT
    // ============================================

    // Countries - Admin managed
    match /countries/{countryId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // Cities - Admin managed
    match /cities/{cityId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // Courier Assignments - Admin managed
    match /courier_assignments/{assignmentId} {
      allow read: if isAdmin() ||
                     (isCourier() && resource.data.courierId == request.auth.uid);
      allow create, update, delete: if isAdmin();
    }

    // Users collection (unified user profiles)
    match /users/{userId} {
      // Users can read their own profile
      // Admins can read all profiles
      allow read: if isOwner(userId) || isAdmin();

      // Users can update their own profile (except role and createdAt)
      // Admin can update any user (for operatingCities etc.)
      allow update: if (isOwner(userId) &&
                        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt'])) ||
                       isAdmin();

      // Users can create their own profile, admins can create any
      allow create: if isAdmin() || isOwner(userId);

      // Only admins can delete profiles
      allow delete: if isAdmin();
    }

    // ============================================
    // READ-ONLY COLLECTIONS (managed by backend)
    // ============================================

    // Wallets - Users can create their own wallet during registration
    match /wallets/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      // Users can create their own wallet (initial creation only with zero balance)
      allow create: if isOwner(userId) &&
                       request.resource.data.userId == userId &&
                       request.resource.data.balance == 0 &&
                       request.resource.data.isActive == true;
      // Only Cloud Functions can update/delete
      allow update, delete: if false;
    }

    // Ledger - Read only transaction history
    match /ledger/{transactionId} {
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false;
    }

    // Subscriptions - Read only subscription status
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false;
    }

    // ============================================
    // DELIVERIES
    // SECURITY HARDENING: Consolidated rules with field-level protection
    // ============================================

    match /deliveries/{deliveryId} {
      // READ: Involved parties can read their deliveries
      // Couriers can read pending deliveries in their operating cities
      allow read: if isAuthenticated() && (
                     // Assigned courier can read
                     resource.data.courierId == request.auth.uid ||
                     // Involved pharmacies can read
                     resource.data.fromPharmacyId == request.auth.uid ||
                     resource.data.toPharmacyId == request.auth.uid ||
                     // Admin can read all
                     isAdmin() ||
                     // Couriers can browse pending deliveries in their cities
                     (isCourier() &&
                      resource.data.status == 'pending' &&
                      resource.data.location != null &&
                      resource.data.location.cityId != null &&
                      courierOperatesInCity(resource.data.location.cityId))
                   );

      // UPDATE: Strict field-level control
      // Courier can ONLY modify allowed fields, nothing else
      allow update: if isCourier() && (
                       // Case 1: Assigned courier updating status
                       (resource.data.courierId == request.auth.uid &&
                        request.resource.data.status in ['picked_up', 'in_transit', 'delivered'] &&
                        // IMMUTABLE: Cannot change these fields
                        request.resource.data.exchangeId == resource.data.exchangeId &&
                        request.resource.data.fromPharmacyId == resource.data.fromPharmacyId &&
                        request.resource.data.toPharmacyId == resource.data.toPharmacyId &&
                        request.resource.data.deliveryFee == resource.data.deliveryFee &&
                        request.resource.data.feePerPharmacy == resource.data.feePerPharmacy &&
                        request.resource.data.currency == resource.data.currency &&
                        request.resource.data.medicineDetails == resource.data.medicineDetails &&
                        request.resource.data.fromPharmacyPayment == resource.data.fromPharmacyPayment &&
                        request.resource.data.toPharmacyPayment == resource.data.toPharmacyPayment) ||

                       // Case 2: Courier accepting a pending delivery in their city
                       (resource.data.status == 'pending' &&
                        resource.data.courierId == null &&
                        request.resource.data.courierId == request.auth.uid &&
                        request.resource.data.status == 'assigned' &&
                        resource.data.location != null &&
                        resource.data.location.cityId != null &&
                        courierOperatesInCity(resource.data.location.cityId) &&
                        // IMMUTABLE: Cannot change these fields when accepting
                        request.resource.data.exchangeId == resource.data.exchangeId &&
                        request.resource.data.fromPharmacyId == resource.data.fromPharmacyId &&
                        request.resource.data.toPharmacyId == resource.data.toPharmacyId &&
                        request.resource.data.deliveryFee == resource.data.deliveryFee &&
                        request.resource.data.feePerPharmacy == resource.data.feePerPharmacy &&
                        request.resource.data.currency == resource.data.currency &&
                        request.resource.data.medicineDetails == resource.data.medicineDetails)
                     );

      // CREATE/DELETE: Only Cloud Functions (Admin SDK)
      allow create, delete: if false;
    }

    // Subscription Plans - Read by all, managed by admins
    match /subscription_plans/{planId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // Top-up Requests - Users can create and read their own requests
    match /topup_requests/{requestId} {
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.amount > 0;
      allow update, delete: if false;
    }

    // Subscription Requests - Users can create and read their own requests
    match /subscription_requests/{requestId} {
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // ============================================
    // COURIER EARNINGS & PAYMENTS
    // All mutations handled by Cloud Functions only
    // ============================================

    // Courier Earnings - Read only for couriers
    match /courier_earnings/{earningId} {
      allow read: if isAuthenticated() &&
                     (resource.data.courierId == request.auth.uid || isAdmin());
      // CRITICAL: Only Cloud Functions can write
      allow create, update, delete: if false;
    }

    // Courier Wallets - Couriers can read and update preferences only
    match /courier_wallets/{courierId} {
      allow read: if isOwner(courierId) || isAdmin();

      // Courier can create their own wallet (zero balances only)
      allow create: if isOwner(courierId) &&
                       isCourier() &&
                       request.resource.data.courierId == courierId &&
                       request.resource.data.availableBalance == 0 &&
                       request.resource.data.pendingBalance == 0 &&
                       request.resource.data.totalEarned == 0 &&
                       request.resource.data.totalWithdrawn == 0;

      // Courier can ONLY update payment preferences, NOT balances
      allow update: if isOwner(courierId) &&
                       isCourier() &&
                       request.resource.data.courierId == courierId &&
                       // BLOCK all balance field changes
                       request.resource.data.availableBalance == resource.data.availableBalance &&
                       request.resource.data.pendingBalance == resource.data.pendingBalance &&
                       request.resource.data.totalEarned == resource.data.totalEarned &&
                       request.resource.data.totalWithdrawn == resource.data.totalWithdrawn;

      allow delete: if false;
    }

    // Courier Payouts - Read only
    match /courier_payouts/{payoutId} {
      allow read: if isAuthenticated() &&
                     (resource.data.courierId == request.auth.uid || isAdmin());
      // CRITICAL: Only Cloud Functions can write
      allow create, update, delete: if false;
    }

    // Delivery Fee Configs - Admin managed
    match /delivery_fee_configs/{configId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // IDEMPOTENCY KEYS (Cloud Functions only)
    // ============================================

    match /idempotency_keys/{keyId} {
      // No client access
      allow read, write: if false;
    }

    // ============================================
    // AUDIT LOGS
    // SECURITY FIX: Server-only writes to prevent forgery/flooding
    // ============================================

    match /audit_logs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      // SECURITY FIX: Only Cloud Functions can write audit logs
      // This prevents log forgery and flooding attacks
      allow create, update, delete: if false;
    }

    // ============================================
    // DENY ALL OTHER ACCESS
    // ============================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
