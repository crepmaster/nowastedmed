rules_version = '2';

/**
 * Firestore Security Rules for NoWastedMed (MediExchange)
 *
 * These rules enforce access control for the medicine exchange platform.
 *
 * Collections:
 * - pharmacies: Pharmacist user profiles
 * - couriers: Courier user profiles
 * - admins: Admin user profiles
 * - exchanges: Medicine exchange requests
 * - exchange_proposals: Counter-proposals for exchanges
 * - pharmacy_inventory: Medicine inventory
 *
 * DEPLOYMENT:
 * firebase deploy --only firestore:rules
 *
 * TESTING:
 * Use Firebase Emulator Suite for local testing
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user is accessing their own document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Get user's role from their profile
    function getUserRole() {
      let pharmacyDoc = get(/databases/$(database)/documents/pharmacies/$(request.auth.uid));
      let courierDoc = get(/databases/$(database)/documents/couriers/$(request.auth.uid));
      let adminDoc = get(/databases/$(database)/documents/admins/$(request.auth.uid));

      return pharmacyDoc.data != null ? 'pharmacist' :
             courierDoc.data != null ? 'courier' :
             adminDoc.data != null ? 'admin' : null;
    }

    // Check if user is a pharmacist
    function isPharmacist() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/pharmacies/$(request.auth.uid));
    }

    // Check if user is a courier
    function isCourier() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/couriers/$(request.auth.uid));
    }

    // Check if user is an admin
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Validate string field length
    function validString(field, minLen, maxLen) {
      return field is string && field.size() >= minLen && field.size() <= maxLen;
    }

    // Validate required string field
    function validRequiredString(field) {
      return field is string && field.size() > 0;
    }

    // Check if courier operates in a specific city
    // Looks up the courier's operatingCities array in the users collection
    function courierOperatesInCity(cityId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null &&
             userDoc.data.role == 'courier' &&
             userDoc.data.operatingCities != null &&
             cityId in userDoc.data.operatingCities;
    }

    // ============================================
    // USER PROFILE COLLECTIONS
    // ============================================

    // Pharmacies collection
    match /pharmacies/{userId} {
      // Users can read their own profile
      // Admins can read all profiles
      // Other pharmacists can read basic info for exchange purposes
      allow read: if isOwner(userId) || isAdmin() || isPharmacist();

      // Only the user can update their own profile (except isActive which admin controls)
      allow update: if isOwner(userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']);

      // Users cannot create their own profiles directly (done through Cloud Functions)
      // Admins can create profiles
      allow create: if isAdmin();

      // Only admins can delete profiles
      allow delete: if isAdmin();
    }

    // Couriers collection
    match /couriers/{userId} {
      // Users can read their own profile
      // Admins can read all profiles
      // Pharmacists can read courier info for delivery tracking
      allow read: if isOwner(userId) || isAdmin() || isPharmacist();

      // Only the user can update their own profile
      allow update: if isOwner(userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']);

      // Users cannot create their own profiles directly
      allow create: if isAdmin();

      // Only admins can delete profiles
      allow delete: if isAdmin();
    }

    // Admins collection
    match /admins/{userId} {
      // Only the admin can read their own profile
      // Other admins can read for verification
      allow read: if isOwner(userId) || isAdmin();

      // Only the user can update their own profile
      allow update: if isOwner(userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']);

      // Only existing admins can create new admins
      allow create: if isAdmin();

      // Only admins can delete admin profiles
      allow delete: if isAdmin();
    }

    // ============================================
    // PHARMACY INVENTORY
    // ============================================

    match /pharmacy_inventory/{medicineId} {
      // Pharmacies can read their own inventory
      // Other pharmacies can read medicines available for exchange
      // Admins can read all for statistics
      allow read: if isAuthenticated() && (
                     resource.data.pharmacyId == request.auth.uid ||
                     resource.data.availableForExchange == true ||
                     isAdmin()
                   );

      // Pharmacy can only create medicines for their own inventory
      allow create: if isPharmacist() &&
                       request.resource.data.pharmacyId == request.auth.uid &&
                       validRequiredString(request.resource.data.name) &&
                       request.resource.data.quantity >= 0;

      // Pharmacy can only update their own medicines
      allow update: if isPharmacist() &&
                       resource.data.pharmacyId == request.auth.uid &&
                       request.resource.data.pharmacyId == request.auth.uid &&
                       request.resource.data.quantity >= 0;

      // Pharmacy can only delete their own medicines
      allow delete: if isPharmacist() &&
                       resource.data.pharmacyId == request.auth.uid;
    }

    // ============================================
    // EXCHANGES
    // ============================================

    match /exchanges/{exchangeId} {
      // Both proposer and recipient can read the exchange
      // Couriers can read exchanges they are delivering
      // Admins can read all
      allow read: if isAuthenticated() && (
                     resource.data.proposedBy == request.auth.uid ||
                     resource.data.proposedTo == request.auth.uid ||
                     resource.data.courierId == request.auth.uid ||
                     isAdmin()
                   );

      // Only pharmacists can create exchanges
      // Must be the proposer
      allow create: if isPharmacist() &&
                       request.resource.data.proposedBy == request.auth.uid &&
                       validRequiredString(request.resource.data.proposedTo) &&
                       request.resource.data.status in ['draft', 'pending', 'requested'];

      // Both parties can update exchange (accept/reject)
      // Courier can update status when delivering
      allow update: if isAuthenticated() && (
                       // Proposer can update their own exchange
                       (resource.data.proposedBy == request.auth.uid &&
                        request.resource.data.proposedBy == resource.data.proposedBy) ||
                       // Recipient can accept/reject
                       (resource.data.proposedTo == request.auth.uid &&
                        request.resource.data.status in ['accepted', 'rejected', 'pending']) ||
                       // Courier can update delivery status
                       (isCourier() &&
                        resource.data.courierId == request.auth.uid &&
                        request.resource.data.status in ['in_transit', 'completed']) ||
                       // Admin can update any exchange
                       isAdmin()
                     );

      // Only proposer can delete draft exchanges
      // Admins can delete any
      allow delete: if (isPharmacist() &&
                        resource.data.proposedBy == request.auth.uid &&
                        resource.data.status == 'draft') ||
                       isAdmin();
    }

    // ============================================
    // EXCHANGE PROPOSALS
    // ============================================

    match /exchange_proposals/{proposalId} {
      // Read the parent exchange to verify access
      function getParentExchange() {
        return get(/databases/$(database)/documents/exchanges/$(resource.data.exchangeId));
      }

      // Both parties involved in the exchange can read proposals
      allow read: if isAuthenticated() && (
                     getParentExchange().data.proposedBy == request.auth.uid ||
                     getParentExchange().data.proposedTo == request.auth.uid ||
                     isAdmin()
                   );

      // Only parties in the exchange can create proposals
      allow create: if isPharmacist() &&
                       request.resource.data.proposedBy == request.auth.uid;

      // Only parties can update proposal status
      allow update: if isAuthenticated() && (
                       getParentExchange().data.proposedBy == request.auth.uid ||
                       getParentExchange().data.proposedTo == request.auth.uid
                     );

      // Only proposer can delete their proposal
      allow delete: if isPharmacist() &&
                       resource.data.proposedBy == request.auth.uid;
    }

    // ============================================
    // ADMIN LOCATION MANAGEMENT
    // ============================================

    // Countries - Admin managed
    match /countries/{countryId} {
      // All authenticated users can read countries
      allow read: if isAuthenticated();
      // Only admins can create, update, delete
      allow create, update, delete: if isAdmin();
    }

    // Cities - Admin managed
    match /cities/{cityId} {
      // All authenticated users can read cities
      allow read: if isAuthenticated();
      // Only admins can create, update, delete
      allow create, update, delete: if isAdmin();
    }

    // Courier Assignments - Admin managed
    match /courier_assignments/{assignmentId} {
      // Admins and the assigned courier can read
      allow read: if isAdmin() ||
                     (isCourier() && resource.data.courierId == request.auth.uid);
      // Only admins can create, update, delete
      allow create, update, delete: if isAdmin();
    }

    // Users collection (unified user profiles)
    match /users/{userId} {
      // Users can read their own profile
      // Admins can read all profiles
      // Pharmacists can read other users for exchange purposes
      allow read: if isOwner(userId) || isAdmin() || isPharmacist();

      // Users can update their own profile (except role and createdAt)
      allow update: if isOwner(userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']);

      // Admin can update courier's operatingCities
      allow update: if isAdmin();

      // Admins can create profiles
      allow create: if isAdmin() || isOwner(userId);

      // Only admins can delete profiles
      allow delete: if isAdmin();
    }

    // ============================================
    // READ-ONLY COLLECTIONS (managed by backend)
    // ============================================

    // Wallets - Read only for users, managed by Cloud Functions
    match /wallets/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if false; // Only Cloud Functions can write
    }

    // Ledger - Read only transaction history
    match /ledger/{transactionId} {
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false; // Only Cloud Functions can write
    }

    // Subscriptions - Read only subscription status
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow write: if false; // Only Cloud Functions can write
    }

    // Deliveries - Couriers can read/update their assigned deliveries
    match /deliveries/{deliveryId} {
      // Users can read deliveries they are involved in
      allow read: if isAuthenticated() && (
                     resource.data.courierId == request.auth.uid ||
                     resource.data.fromPharmacyId == request.auth.uid ||
                     resource.data.toPharmacyId == request.auth.uid ||
                     isAdmin()
                   );
      // SECURITY FIX: Couriers can only read pending deliveries in their operating cities
      // This prevents couriers from seeing delivery addresses outside their assigned areas
      allow read: if isCourier() &&
                     resource.data.status == 'pending' &&
                     resource.data.location != null &&
                     resource.data.location.cityId != null &&
                     courierOperatesInCity(resource.data.location.cityId);
      // Couriers can update delivery status for their assigned deliveries
      allow update: if isCourier() &&
                       resource.data.courierId == request.auth.uid &&
                       request.resource.data.status in ['picked_up', 'in_transit', 'delivered'];
      // Couriers can accept pending deliveries only in their operating cities
      allow update: if isCourier() &&
                       resource.data.status == 'pending' &&
                       request.resource.data.courierId == request.auth.uid &&
                       request.resource.data.status == 'assigned' &&
                       resource.data.location != null &&
                       resource.data.location.cityId != null &&
                       courierOperatesInCity(resource.data.location.cityId);
      allow create, delete: if false; // Only Cloud Functions
    }

    // Subscription Plans - Read by all, managed by admins
    match /subscription_plans/{planId} {
      // All authenticated users can read plans
      allow read: if isAuthenticated();
      // Only admins can create, update, delete plans
      allow create, update, delete: if isAdmin();
    }

    // Top-up Requests - Users can create and read their own requests
    match /topup_requests/{requestId} {
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.amount > 0;
      allow update, delete: if false; // Only Cloud Functions
    }

    // Subscription Requests - Users can create and read their own requests
    match /subscription_requests/{requestId} {
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Only Cloud Functions
    }

    // ============================================
    // COURIER EARNINGS & PAYMENTS
    // ============================================

    // Courier Earnings - Couriers can read their own earnings
    match /courier_earnings/{earningId} {
      // Couriers can read their own earnings
      // Admins can read all for payout processing
      allow read: if isAuthenticated() &&
                     (resource.data.courierId == request.auth.uid || isAdmin());
      // Earnings are created when a courier confirms delivery
      // The courier creating must match the courierId in the earning
      // and must be in pending status with proper amounts
      allow create: if isCourier() &&
                       request.resource.data.courierId == request.auth.uid &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.amount > 0 &&
                       request.resource.data.netAmount > 0;
      // Only admins can update earning status (for payout processing)
      // Or courier's own earnings for status updates (pending -> available -> processing)
      allow update: if isAdmin() ||
                       (isCourier() &&
                        resource.data.courierId == request.auth.uid &&
                        request.resource.data.status in ['available', 'processing']);
      allow delete: if false;
    }

    // Courier Wallets - Couriers can read their own wallet
    match /courier_wallets/{courierId} {
      // Courier can read their own wallet
      allow read: if isOwner(courierId) || isAdmin();

      // Courier can create their own wallet (initial creation only)
      // Wallet is created with zero balances when courier first accesses it
      allow create: if isOwner(courierId) &&
                       isCourier() &&
                       request.resource.data.courierId == courierId &&
                       request.resource.data.availableBalance == 0 &&
                       request.resource.data.pendingBalance == 0 &&
                       request.resource.data.totalEarned == 0 &&
                       request.resource.data.totalWithdrawn == 0;

      // Couriers can update their own wallet for:
      // 1. Payment preferences (always allowed)
      // 2. Balance updates (pendingBalance, availableBalance, totalEarned)
      //    - pendingBalance can increase (new earnings) or decrease (moved to available)
      //    - availableBalance can increase (from pending) or decrease (payout requested)
      //    - totalEarned can only increase
      // Note: For production, balance updates should ideally be handled by Cloud Functions
      allow update: if isOwner(courierId) &&
                       isCourier() &&
                       request.resource.data.courierId == courierId &&
                       // Ensure totalWithdrawn doesn't decrease (prevents fraud)
                       request.resource.data.totalWithdrawn >= resource.data.totalWithdrawn &&
                       // Ensure balances don't go negative
                       request.resource.data.availableBalance >= 0 &&
                       request.resource.data.pendingBalance >= 0;

      // Admins can update wallet balances (for payouts, earnings processing)
      allow update: if isAdmin();

      allow delete: if false;
    }

    // Courier Payouts - Couriers can read and request payouts
    match /courier_payouts/{payoutId} {
      // Courier can read their own payouts
      // Admins can read all for processing
      allow read: if isAuthenticated() &&
                     (resource.data.courierId == request.auth.uid || isAdmin());
      // Couriers can create payout requests
      allow create: if isCourier() &&
                       request.resource.data.courierId == request.auth.uid &&
                       request.resource.data.amount > 0 &&
                       request.resource.data.status == 'pending';
      // Only admins can update payout status (approve/reject)
      allow update: if isAdmin();
      allow delete: if false;
    }

    // Delivery Fee Configs - Admin managed
    match /delivery_fee_configs/{configId} {
      // All authenticated users can read fee configs
      allow read: if isAuthenticated();
      // Only admins can manage fee configurations
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // AUDIT LOGS
    // ============================================

    // Audit logs are immutable - can only be created, never updated or deleted
    match /audit_logs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      // Authenticated users can create audit logs for their own actions
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.timestamp != null;
      // No updates or deletes allowed - audit logs are immutable
      allow update, delete: if false;
    }

    // ============================================
    // DENY ALL OTHER ACCESS
    // ============================================

    // Catch-all rule - deny access to any undefined collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
